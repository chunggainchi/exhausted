<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>LeseSpa√ü Word Lab (Rebuild)</title>
  <style>
    :root {
      --bg: #0d1117; --ink: #e6ebf2; --ink-dim: #AFB6C3; --accent: #10b981; --accent-2: #34d399; --success: #22c55e;
    }
    html, body {
      margin: 0; height: 100%; width: 100%; overflow: hidden;
      background: var(--bg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--ink);
    }
    /* Main container using Flexbox for centering */
    #app-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
      gap: 20px;
    }
    /* The image card */
    #card {
      width: 100%;
      max-width: 450px;
      aspect-ratio: 4 / 3;
      background-color: rgba(255, 255, 255, 0.06);
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 15px;
      box-sizing: border-box;
    }
    #card img {
      max-width: 100%;
      max-height: 100%;
      object-fit: cover;
      border-radius: 12px;
    }
    /* Syllable containers */
    #word-display { font-size: 36px; font-weight: 500; }
    #slots-container, #bank-container {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .slot {
      width: 120px;
      height: 56px;
      border: 2px dashed rgba(255, 255, 255, 0.35);
      border-radius: 14px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 30px;
      color: var(--ink);
      transition: all 0.2s ease;
    }
    .slot.next {
      border-style: solid;
      border-color: var(--accent);
      box-shadow: 0 0 15px var(--accent);
    }
    /* Syllable and control buttons */
    .syllable-btn, .control-btn {
      border: none;
      border-radius: 14px;
      font-size: 30px;
      color: var(--ink);
      font-family: inherit;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }
    .syllable-btn {
      width: 120px;
      height: 56px;
      background-image: linear-gradient(to right, #334155, #475569);
    }
    .syllable-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    }
    #controls-container {
      position: absolute;
      bottom: 20px;
      left: 20px;
      right: 20px;
      display: flex;
      justify-content: space-between;
    }
    .control-btn {
      background-image: linear-gradient(to right, var(--accent), var(--accent-2));
      padding: 10px 25px;
      font-size: 20px;
    }
    /* Confetti container */
    #confetti-container {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; overflow: hidden;
    }
    .confetti {
        position: absolute; width: 8px; height: 8px;
        background-color: var(--success); border-radius: 4px;
        animation: fall 1s linear forwards;
    }
    @keyframes fall {
        to { transform: translateY(100vh); opacity: 0; }
    }
  </style>
</head>
<body>
  
  <div id="app-container">
    <div id="card">
      <img id="word-image" src="" alt="Word Image">
    </div>
    <div id="word-display"></div>
    <div id="slots-container"></div>
    <div id="bank-container"></div>
  </div>

  <div id="controls-container">
      <button id="speak-btn" class="control-btn">üîä Vorlesen</button>
      <button id="next-btn" class="control-btn">Weiter ‚û°Ô∏è</button>
  </div>
  
  <div id="confetti-container"></div>

<script>
/* ===========================================================
   LeseSpa√ü Word Lab ‚Äî Rebuild from the Ground Up
   =========================================================== */

// -----------------------------------------------------------
// 1. DATA AND STATE
// -----------------------------------------------------------
const WORDS = [ { id:'du',  text:'du',  syll:[0,1], img:'https://images.unsplash.com/photo-1532348904171-919f8b2b7e62?q=80&w=1740&auto=format&fit=crop' }, { id:'im',  text:'im',  syll:[0,1], img:'https://www.shutterstock.com/image-vector/boy-playing-hide-seek-box-600nw-762258736.jpg' }, { id:'da',  text:'da',  syll:[0,1], img:'https://plus.unsplash.com/premium_photo-1729860559950-da4570b34e21?q=80&w=774&auto=format&fit=crop' }, { id:'oma',   text:'Oma',   syll:[0,1], img:'https://images.unsplash.com/photo-1577048982771-1960014bde8b?q=80&w=776&auto=format&fit=crop' }, { id:'opa',   text:'Opa',   syll:[0,1], img:'https://images.unsplash.com/photo-1586498024141-1940debde48d?q=80&w=774&auto=format&fit=crop' }, { id:'mama',  text:'Mama',  syll:[0,2], img:'https://images.unsplash.com/photo-1542385151-efd9000785a0?q=80&w=778&auto=format&fit=crop' }, { id:'papa',  text:'Papa',  syll:[0,2], img:'https://images.unsplash.com/photo-1593323925814-253c803de3a5?q=80&w=770&auto=format&fit=crop' } ];
const PRONUNCIATION_MAP = { a:'ah', e:'eh', i:'ih', o:'oh', u:'uh', m:'m', p:'p', d:'d' };

const state = {
    wordIndex: 0,
    currentSyllables: [],
    slots: [],
    nextSlotIndex: 0,
};

// -----------------------------------------------------------
// 2. SPEECH ENGINE (CLEAN AND ISOLATED)
// -----------------------------------------------------------
let voiceDE = null;
let voicesReady = false;

async function initializeSpeech() {
    if (!('speechSynthesis' in window)) {
        console.error("TTS not supported");
        return;
    }
    // Prime the engine on the first user interaction
    document.body.addEventListener('pointerdown', () => {
        speechSynthesis.speak(new SpeechSynthesisUtterance(''));
    }, { once: true });
    
    const voices = await new Promise(resolve => {
        const get = () => { const v = speechSynthesis.getVoices(); if (v.length) resolve(v); };
        speechSynthesis.onvoiceschanged = get; get();
    });
    
    const deVoices = voices.filter(v => v.lang.startsWith('de'));
    if (deVoices.length > 0) {
        voiceDE = deVoices.find(v => v.name.includes('Anna')) || deVoices.find(v => v.localService) || deVoices[0];
        console.log("Selected German voice:", voiceDE.name);
        voicesReady = true;
    } else {
        console.error("No German voices found.");
    }
}

function speak(text, options = {}) {
    if (!voicesReady || !voiceDE) return;
    try {
        speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.voice = voiceDE;
        utterance.lang = voiceDE.lang;
        utterance.rate = options.rate || 0.85;
        speechSynthesis.speak(utterance);
    } catch (e) {
        console.error("Speech Synthesis Error:", e);
    }
}

// -----------------------------------------------------------
// 3. CORE LOGIC
// -----------------------------------------------------------
function setupWord(index) {
    const word = WORDS[index];
    state.wordIndex = index;
    state.nextSlotIndex = 0;
    
    // Create syllables and slots from word data
    state.currentSyllables = [];
    state.slots = [];
    for(let i=0; i<word.syll.length; i++){
        const start = word.syll[i];
        const end = (i+1 < word.syll.length) ? word.syll[i+1] : word.text.length;
        const chunk = word.text.slice(start, end);
        state.currentSyllables.push({ text: chunk, originalIndex: i });
        state.slots.push({ expected: chunk, filled: '' });
    }
    
    // Shuffle syllables for the bank
    state.currentSyllables.sort(() => Math.random() - 0.5);
    
    render();
}

function handleSyllableClick(syllableText, originalIndex) {
    const expectedSyllable = state.slots[state.nextSlotIndex].expected;
    const chunkToSpeak = PRONUNCIATION_MAP[syllableText.toLowerCase()] || syllableText;
    speak(chunkToSpeak, { rate: 0.75 });

    if (syllableText === expectedSyllable) {
        state.slots[state.nextSlotIndex].filled = syllableText;
        state.nextSlotIndex++;
        
        // Disable the correctly chosen button
        const button = document.querySelector(`.syllable-btn[data-index='${originalIndex}']`);
        if (button) button.disabled = true;

        if (state.nextSlotIndex === state.slots.length) {
            handleWin();
        }
        render();
    }
}

function handleWin() {
    const word = WORDS[state.wordIndex];
    speak(word.text);
    
    // Simple confetti effect
    for(let i = 0; i < 30; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = (Math.random() * 100) + 'vw';
        confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 70%, 60%)`;
        confetti.style.animationDelay = (Math.random() * 0.5) + 's';
        document.getElementById('confetti-container').appendChild(confetti);
        setTimeout(() => confetti.remove(), 1500);
    }
    
    setTimeout(() => {
        const nextIndex = (state.wordIndex + 1) % WORDS.length;
        setupWord(nextIndex);
    }, 1200);
}

// -----------------------------------------------------------
// 4. RENDERING (Updating the DOM)
// -----------------------------------------------------------
function render() {
    const word = WORDS[state.wordIndex];
    
    // Update image
    document.getElementById('word-image').src = word.img;
    
    // Update word display (hidden until win)
    document.getElementById('word-display').textContent = state.nextSlotIndex === state.slots.length ? word.text : '';

    // Render slots
    const slotsContainer = document.getElementById('slots-container');
    slotsContainer.innerHTML = '';
    state.slots.forEach((slot, index) => {
        const el = document.createElement('div');
        el.className = 'slot';
        if (index === state.nextSlotIndex) {
            el.classList.add('next');
        }
        el.textContent = slot.filled || '';
        slotsContainer.appendChild(el);
    });

    // Render syllable bank buttons
    const bankContainer = document.getElementById('bank-container');
    bankContainer.innerHTML = '';
    state.currentSyllables.forEach(syllable => {
        const isFilled = state.slots.some(s => s.filled === syllable.text);
        if (!isFilled) {
            const btn = document.createElement('button');
            btn.className = 'syllable-btn';
            btn.textContent = syllable.text;
            btn.dataset.index = syllable.originalIndex;
            btn.onclick = () => handleSyllableClick(syllable.text, syllable.originalIndex);
            bankContainer.appendChild(btn);
        }
    });
}

// -----------------------------------------------------------
// 5. INITIALIZATION
// -----------------------------------------------------------
async function main() {
    await initializeSpeech();

    // Setup button event listeners
    document.getElementById('speak-btn').onclick = () => speak(WORDS[state.wordIndex].text);
    document.getElementById('next-btn').onclick = () => {
        const nextIndex = (state.wordIndex + 1) % WORDS.length;
        setupWord(nextIndex);
    };

    // Load the first word
    setupWord(0);
}

main();

</script>
</body>
</html>