<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>CantoPlay — Lernen auf Canvas</title>
  <style>
    :root {
      --bg: #0d1117;
      --ink: #e6ebf2;
      --ink-dim: #AFB6C3;
      --accent: #8b5cf6;
      --accent-2: #22d3ee;
      --success: #22c55e;
      --warn: #f59e0b;
      --danger: #ef4444;
    }
    html, body { margin: 0; height: 100%; background: radial-gradient(1200px 800px at 70% 20%, rgba(139,92,246,0.15), transparent 50%), radial-gradient(900px 600px at 30% 80%, rgba(34,211,238,0.12), transparent 50%), var(--bg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    canvas { display: block; width: 100vw; height: 100vh; touch-action: none; }
  </style>
</head>
<body>
<canvas id="app"></canvas>
<script>
// ========= Data provided by Sharon =========
const WORDS=[
  {id:'hello', photo:'hello', yue:'你好', de:'Hallo'},
  {id:'thanks', photo:'thanks', yue:'多謝', de:'Danke'},
  {id:'toilet', photo:'toilet', yue:'廁所喺邊？', de:'Wo ist die Toilette?'},
  {id:'hungry', photo:'hungry', yue:'我好肚餓', de:'Ich habe Hunger'},
  {id:'thirsty', photo:'thirsty', yue:'我好口渴', de:'Ich habe Durst'},
  {id:'rice', photo:'rice', yue:'白飯', de:'Reis'},
  {id:'noodles', photo:'noodles', yue:'麵', de:'Nudeln'},
  {id:'dumpling', photo:'dumpling', yue:'餃子', de:'Dumpling'},
  {id:'yummy', photo:'yummy', yue:'好好味', de:'Lecker'},
  {id:'full', photo:'full', yue:'我食飽啦', de:'Ich bin satt'},
  {id:'sorry', photo:'sorry', yue:'對唔住', de:'Entschuldigung'},
  {id:'where', photo:'where', yue:'喺邊度？', de:'Wo?'},
  {id:'oldaunt', photo:'oldaunt', yue:'嬸嬸你好', de:'Hallo alte Dame'},
  {id:'uncle', photo:'uncle', yue:'叔叔你好', de:'Hallo Onkel'},
  {id:'aunt', photo:'aunt', yue:'Yee Yee 你好', de:'Hallo Tante'},
  {id:'friend', photo:'friend', yue:'我哋做朋友啦', de:'Lass uns Freunde sein'},
  {id:'play', photo:'play', yue:'一齊玩', de:'Zusammen spielen'},
  {id:'buy', photo:'buy', yue:'我想買呢個', de:'Ich möchte das kaufen'},
  {id:'howmuch', photo:'howmuch', yue:'幾多錢？', de:'Wie viel kostet das?'},
  {id:'bus', photo:'bus', yue:'巴士站喺邊？', de:'Wo ist die Bushaltestelle?'},
  {id:'train', photo:'train', yue:'地鐵', de:'U‑Bahn/MTR'},
  {id:'taxi', photo:'taxi', yue:'的士', de:'Taxi'},
  {id:'hot', photo:'hot', yue:'好熱', de:'Heiß'},
  {id:'cold', photo:'cold', yue:'好凍', de:'Kalt'},
  {id:'help', photo:'help', yue:'幫下手', de:'Hilf mir bitte'},
  {id:'toilet2', photo:'toilet2', yue:'我要去廁所', de:'Ich muss aufs Klo'},
  {id:'bye', photo:'bye', yue:'拜拜', de:'Tschüss'},
];
const PHOTO_URLS={
  hello:'https://images.unsplash.com/photo-1560265036-021b3652b490?q=80&w=1932&auto=format&fit=crop',
  thanks:'https://fennellseeds.com/wp-content/uploads/2020/01/How-To-Teach-Kids-to-Say-Please-and-Thank-You-FB.jpg',
  toilet:'https://images.unsplash.com/photo-1589824783837-6169889fa20f?q=80&w=1740&auto=format&fit=crop',
  hungry:'https://c02.purpledshub.com/uploads/sites/41/2022/07/Hangry-GettyImages-1306862188-0bb4fd9.jpg',
  thirsty:'https://images.unsplash.com/photo-1529079337819-f6d0024bd364?q=80&w=1740&auto=format&fit=crop',
  rice:'https://images.unsplash.com/photo-1536304993881-ff6e9eefa2a6?q=80&w=1740&auto=format&fit=crop',
  noodles:'https://images.unsplash.com/photo-1559942144-92147a3adb0f?q=80&w=1548&auto=format&fit=crop',
  dumpling:'https://images.unsplash.com/photo-1638502338747-f7f368214cce?q=80&w=1740&auto=format&fit=crop',
  yummy:'https://static.vecteezy.com/system/resources/thumbnails/006/431/822/small_2x/yummy-smile-emoji-with-tongue-lick-mouth-delicious-tasty-food-symbol-for-social-network-yummy-and-hungry-icon-savory-gourmet-enjoy-food-sign-illustration-isolated-on-yellow-background-vector.jpg',
  full:'https://thumb.ac-illust.com/a7/a76b257643051af0fdbe2683bc4be826_t.jpeg',
  sorry:'https://images.unsplash.com/photo-1483193722442-5422d99849bc?q=80&w=1740&auto=format&fit=crop',
  where:'https://www.scienceofpeople.com/wp-content/uploads/2021/03/Lauren-Hands-MeasuringThisAndThat-YoungAdult-Female-Front-1024x683.jpg',
  oldaunt:'https://images.unsplash.com/photo-1612177434015-83ee396a236d?q=80&w=1746&auto=format&fit=crop',
  uncle:'https://images.unsplash.com/photo-1545830571-6d7665a05cb6?q=80&w=1740&auto=format&fit=crop',
  aunt:'https://images.unsplash.com/photo-1528813860492-bb99459ec095?q=80&w=1740&auto=format&fit=crop',
  friend:'https://images.unsplash.com/photo-1627764940620-90393d0e8c34?q=80&w=1740&auto=format&fit=crop',
  play:'https://images.unsplash.com/photo-1541692641319-981cc79ee10a?q=80&w=1740&auto=format&fit=crop',
  buy:'https://images.unsplash.com/photo-1546226271-450e37cf85d0?q=80&w=1740&auto=format&fit=crop',
  howmuch:'https://images.unsplash.com/photo-1624926879763-b3da31033618?q=80&w=1748&auto=format&fit=crop',
  bus:'https://images.unsplash.com/photo-1650162033950-4cca7155dfd9?q=80&w=1548&auto=format&fit=crop',
  train:'https://images.unsplash.com/photo-1628233742482-e651dbb2ad5d?q=80&w=1738&auto=format&fit=crop',
  taxi:'https://images.unsplash.com/photo-1688957511049-5433847253ec?q=80&w=1716&auto=format&fit=crop',
  hot:'https://images.unsplash.com/photo-1543005472-1b1d37fa4eae?q=80&w=774&auto=format&fit=crop',
  cold:'https://images.unsplash.com/photo-1520889905494-a9ba556b0cf2?q=80&w=1626&auto=format&fit=crop',
  help:'https://images.unsplash.com/photo-1559225306-3f60aa7b39a3?q=80&w=1548&auto=format&fit=crop',
  bye:'https://media.istockphoto.com/id/1663429935/photo/see-you-later.jpg?s=612x612&w=0&k=20&c=PgM6GK41MSU_ElY_KWdb7uX7wAlRiwcu6TO7oo-qqKE=',
  toilet2:'https://dam.northwell.edu/m/3ac740d5100b2bfa/Drupal-TheWell_bladderurge_AS_475303494.jpg'
};

// ========= App State & Globals =========
let activeScene = null;
const MOBILE_BREAKPOINT = 850;
let isMobileView = window.innerWidth <= MOBILE_BREAKPOINT;
let isNavOpen = false;
let burgerBox = { x: 12, y: 12, w: 48, h: 48 };

// ========= Canvas + GFX helpers =========
const canvas = document.getElementById('app');
const ctx = canvas.getContext('2d');
let DPR = Math.max(1, Math.min(2.5, window.devicePixelRatio || 1));

function resize() {
  DPR = Math.max(1, Math.min(2.5, window.devicePixelRatio || 1));
  canvas.width = Math.floor(window.innerWidth * DPR);
  canvas.height = Math.floor(window.innerHeight * DPR);
  canvas.style.width = window.innerWidth + 'px';
  canvas.style.height = window.innerHeight + 'px';
  ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
  
  isMobileView = window.innerWidth <= MOBILE_BREAKPOINT;
  if (!isMobileView) isNavOpen = false; // Close nav if we resize to desktop
  
  if (activeScene?.layout) activeScene.layout();
}
window.addEventListener('resize', resize);
resize();

function rrect(x,y,w,h,r){
  const rr = Math.min(r, Math.min(w,h)/2);
  ctx.beginPath();
  ctx.moveTo(x+rr,y);
  ctx.arcTo(x+w,y,x+w,y+h,rr);
  ctx.arcTo(x+w,y+h,x,y+h,rr);
  ctx.arcTo(x,y+h,x,y,rr);
  ctx.arcTo(x,y,x+w,y,rr);
  ctx.closePath();
}
function gradient(x,y,w,h,c1,c2){
  const g = ctx.createLinearGradient(x,y,x+w,y+h);
  g.addColorStop(0,c1); g.addColorStop(1,c2); return g;
}
function shadow(fn){
  ctx.save(); ctx.shadowColor='rgba(0,0,0,0.45)'; ctx.shadowBlur=18; ctx.shadowOffsetY=8; fn(); ctx.restore();
}
function drawBadge(x,y,text){
  const pad=10; ctx.fillStyle='rgba(255,255,255,0.08)'; rrect(x,y,Math.max(120, ctx.measureText(text).width+pad*2),32,14); ctx.fill();
  ctx.fillStyle='#AFB6C3'; ctx.font='14px system-ui'; ctx.fillText(text,x+pad,y+21);
}

// ========= Input =========
let pointer={x:0,y:0,down:false};
let audioUnlocked=false;

function primeAudio() {
  if (audioUnlocked) return;
  audioUnlocked = true;
  ensureAC();
  try {
    const primingUtterance = new SpeechSynthesisUtterance('');
    speechSynthesis.speak(primingUtterance);
  } catch (e) {}
}

canvas.addEventListener('pointerdown',e=>{
  primeAudio();
  pointer.down=true;
  const rect=canvas.getBoundingClientRect();
  pointer.x=(e.clientX-rect.left);
  pointer.y=(e.clientY-rect.top);

  // Burger menu logic
  if (isMobileView) {
    if (pointer.x >= burgerBox.x && pointer.x <= burgerBox.x + burgerBox.w && pointer.y >= burgerBox.y && pointer.y <= burgerBox.y + burgerBox.h) {
      isNavOpen = !isNavOpen;
      return;
    }
    if (isNavOpen && pointer.x > getActiveSidebarWidth()) {
      isNavOpen = false;
      return; // Prevent click-through when closing menu
    }
  }

  if(handleNavClick(pointer)) return;
  activeScene?.onPointer('down', pointer);
  canvas.setPointerCapture(e.pointerId);
});
canvas.addEventListener('pointermove',e=>{ const rect=canvas.getBoundingClientRect(); pointer.x=(e.clientX-rect.left); pointer.y=(e.clientY-rect.top); activeScene?.onPointer('move', pointer); });
canvas.addEventListener('pointerup',e=>{ pointer.down=false; activeScene?.onPointer('up', pointer); });
window.addEventListener('keydown',e=>{ primeAudio(); if(handleNavKey(e.key)) return; activeScene?.onKey(e.key); });
canvas.addEventListener('wheel', e => {
  if (activeScene instanceof CardsOverviewScene) {
    e.preventDefault();
    activeScene.onScroll(e.deltaY);
  }
}, { passive: false });


// ========= Speech (robust + cross-browser) =========
let voiceHK = null, voiceDE = null;
let voicesReady = false;

function waitForVoices() {
  return new Promise(resolve => {
    const tryLoad = () => {
      const vs = speechSynthesis.getVoices();
      if (vs && vs.length) { resolve(vs); }
      else { setTimeout(tryLoad, 120); }
    };
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = tryLoad;
    }
    tryLoad();
  });
}

function pickVoices(voices) {
  const isHK = v => /zh[-_]?HK|yue|hong\s*kong/i.test(v.lang || "") || /Hong\s*Kong|Cantonese|粵/i.test(v.name || "");
  const isTW = v => /zh[-_]?TW/i.test(v.lang || "");
  const isCN = v => /zh[-_]?CN/i.test(v.lang || "");
  voiceHK = voices.find(isHK) || voices.find(isTW) || voices.find(isCN) || null;

  const preferredDE = [ { name: 'Katja' }, { name: 'Anna', quality: 'Enhanced'}, { name: 'Conrad' }, { name: 'Google Deutsch' }, { name: 'Microsoft Katja Online'}, ];
  for (const p of preferredDE) {
    const found = voices.find(v => v.lang.startsWith('de') && v.name.includes(p.name));
    if (found) { voiceDE = found; break; }
  }
  if (!voiceDE) {
    const isDE = v => /de[-_]?DE|german|deutsch/i.test(v.lang || "") || /Deutsch|German/i.test(v.name || "");
    voiceDE = voices.find(isDE) || null;
  }
  voicesReady = true;
}

function resumeEngineIfNeeded() {
  try { if (speechSynthesis.paused) speechSynthesis.resume(); } catch (_) {}
}

async function ensureVoicesReady() {
  if (voicesReady) return;
  const voices = await waitForVoices();
  pickVoices(voices);
}

async function speak(text, { voice, lang, rate = 0.92, pitch = 1 } = {}) {
  if (!('speechSynthesis' in window) || !voicesReady) return;
  resumeEngineIfNeeded();
  const u = new SpeechSynthesisUtterance(text);
  if (voice) u.voice = voice;
  if (lang)  u.lang  = lang;
  u.rate = rate;
  u.pitch = pitch;
  try { speechSynthesis.cancel(); speechSynthesis.speak(u); } catch (_) {}
}

const speakYue = (t)=> speak(t, { voice: voiceHK, lang: (voiceHK && voiceHK.lang) || 'zh-HK' });
const speakDe  = (t)=> speak(t, { voice: voiceDE, lang: 'de-DE', rate: 0.95 });

document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') resumeEngineIfNeeded();
});

// ========= Assets =========
const IMAGES = {}; let assetsLoaded = 0; let assetsTotal = WORDS.length;
function loadImages(){
  return new Promise(resolve=>{
    WORDS.forEach(w=>{
      const img = new Image(); img.crossOrigin='anonymous'; img.onload=()=>{ assetsLoaded++; if(assetsLoaded===assetsTotal) resolve(); };
      img.onerror=()=>{ assetsLoaded++; if(assetsLoaded===assetsTotal) resolve(); };
      img.src = PHOTO_URLS[w.photo]; IMAGES[w.photo]=img;
    });
  });
}

// ========= UI Components =========
let actx=null; function ensureAC(){ if(!actx){ try{ actx=new (window.AudioContext||window.webkitAudioContext)(); }catch(e){} } }
function tone(freq, dur=0.15, type='sine', gain=0.05){ ensureAC(); if(!actx) return; const t=actx.currentTime; const o=actx.createOscillator(); const g=actx.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(actx.destination); o.start(t); o.stop(t+dur); }
function fxPositive(){ [523,659,784].forEach((f,i)=> setTimeout(()=>tone(f,0.12,'triangle',0.06), i*120)); }
function fxNegative(){ tone(220,0.18,'sawtooth',0.05); setTimeout(()=>tone(196,0.2,'sawtooth',0.04),140); }
class Button { constructor(label, emoji, x, y, w, h, onClick){ this.label=label; this.emoji=emoji; this.x=x; this.y=y; this.w=w; this.h=h; this.onClick=onClick; this.hover=false; } contains(px,py){ return px>=this.x && py>=this.y && px<=this.x+this.w && py<=this.y+this.h; } draw(){ ctx.save(); const c1=this.hover?'#8b5cf6':'#6d28d9', c2=this.hover?'#22d3ee':'#0ea5e9'; shadow(()=>{ ctx.fillStyle=gradient(this.x,this.y,this.w,this.h,c1,c2); rrect(this.x,this.y,this.w,this.h,20); ctx.fill();}); ctx.fillStyle='rgba(255,255,255,0.92)'; ctx.font='20px system-ui'; const text=`${this.emoji?this.emoji+'  ':''}${this.label}`; const tw=ctx.measureText(text).width; ctx.fillText(text,this.x+(this.w-tw)/2,this.y+this.h/2+6); ctx.restore(); } }

// ========= Navigation (left sidebar) =========
const SIDEBAR_W = 230; let navBoxes=[];
const NAV=[
  {id:'home', label:'Home', emoji:'🏠', scene:()=>new HomeScene()},
  {id:'cards', label:'Flashcards', emoji:'🃏', scene:()=>new CardsOverviewScene()},
  {id:'quiz', label:'Quiz', emoji:'🧠', scene:()=>new QuizScene()},
  {id:'game', label:'🐭Game', emoji:'', scene:()=>new MouseCheeseScene()}
];

function getActiveSidebarWidth() {
  if (!isMobileView) return SIDEBAR_W;
  return isNavOpen ? SIDEBAR_W : 0;
}

function drawSidebar(activeId){
  navBoxes=[];
  const H=canvas.clientHeight;
  const sbw = getActiveSidebarWidth();
  if (sbw <= 0) return;
  
  shadow(()=>{ ctx.fillStyle='rgba(255,255,255,0.06)'; rrect(12,12,sbw-24,H-24,22); ctx.fill();});
  ctx.fillStyle='#e6ebf2'; ctx.font='20px system-ui'; ctx.fillText('CantoPlay', 26, 44);
  let y=76; NAV.forEach(item=>{ const isActive=item.id===activeId; const h=54, x=22, w=sbw-44; const c1=isActive?'#22d3ee':'#334155', c2=isActive?'#8b5cf6':'#475569'; shadow(()=>{ ctx.fillStyle=gradient(x,y,w,h,c1,c2); rrect(x,y,w,h,14); ctx.fill();}); ctx.fillStyle='white'; ctx.font='18px system-ui'; const txt=`${item.emoji?item.emoji+' ':''}${item.label}`; const tw=ctx.measureText(txt).width; ctx.fillText(txt, x+Math.max(14,(w-tw)/2), y+34); navBoxes.push({x,y,w,h,id:item.id}); y+=h+12; });
}

function handleNavClick(p){
  const sbw = getActiveSidebarWidth();
  if (sbw <= 0) return false;
  const hit=navBoxes.find(b=> p.x>=b.x && p.x<=b.x+b.w && p.y>=b.y && p.y<=b.y+b.h );
  if (hit){
    const nav=NAV.find(n=>n.id===hit.id);
    if(nav) setScene(nav.scene());
    if(isMobileView) isNavOpen = false;
    return true;
  }
  return false;
}

function handleNavKey(key){ if(key==='h') {setScene(new HomeScene()); return true;} return false; }

function drawBurgerMenu() {
  if (!isMobileView) return;
  
  // Draw dimming overlay if nav is open
  if (isNavOpen) {
    ctx.fillStyle = 'rgba(0,0,0,0.5)';
    ctx.fillRect(getActiveSidebarWidth(), 0, canvas.clientWidth, canvas.clientHeight);
  }

  // Draw burger button
  const {x, y, w, h} = burgerBox;
  shadow(() => {
    ctx.fillStyle = 'rgba(255,255,255,0.08)';
    rrect(x, y, w, h, 12);
    ctx.fill();
  });
  ctx.fillStyle = '#e6ebf2';
  const lineH = 3, lineW = 22;
  const lineX = x + (w-lineW)/2;
  let lineY = y + (h-lineH)/2 - 7;
  rrect(lineX, lineY, lineW, lineH, 1.5); ctx.fill();
  lineY += 7;
  rrect(lineX, lineY, lineW, lineH, 1.5); ctx.fill();
  lineY += 7;
  rrect(lineX, lineY, lineW, lineH, 1.5); ctx.fill();
}


// ========= Scenes =========
class Scene{ update(dt){} draw(){} onPointer(type,p){} onKey(key){} get id(){return 'scene';} layout(){}}

const particles=[]; function emitConfetti(x,y,color='#22c55e',n=18){ for(let i=0;i<n;i++){ particles.push({x,y,vx:(Math.random()-0.5)*6,vy:(Math.random()-1)*6,a:1,c:color}); } }
function updateParticles(dt){ for(let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.12; p.a-=0.02; if(p.a<=0) particles.splice(i,1);} }
function drawParticles(){ particles.forEach(p=>{ ctx.globalAlpha=Math.max(0,p.a); ctx.fillStyle=p.c; rrect(p.x,p.y,5,5,2); ctx.fill(); ctx.globalAlpha=1; }); }

class HomeScene extends Scene{ get id(){return 'home';}
  constructor(){ super(); this.buttons=[]; this.layout(); }
  layout(){ const sbw=getActiveSidebarWidth(); const W=canvas.clientWidth-sbw, H=canvas.clientHeight; const bw=Math.min(360, W*0.8), bh=56; let y = H*0.38; const X = sbw + (W-bw)/2; this.buttons=[ new Button('Flashcards','🃏',X,y,bw,bh,()=> setScene(new CardsOverviewScene())), new Button('Quiz','🧠',X,y+=bh+16,bw,bh,()=> setScene(new QuizScene())), new Button('Spiel: Maus & Käse','🐭🧀',X,y+=bh+16,bw,bh,()=> setScene(new MouseCheeseScene())), ]; }
  draw(){ const W=canvas.clientWidth, H=canvas.clientHeight; drawSidebar(this.id); const sbw=getActiveSidebarWidth(); const CW=W-sbw;
    ctx.fillStyle='rgba(255,255,255,0.95)'; ctx.font = (CW>520? 'bold 46px' : 'bold 34px') + ' system-ui'; const title='CantoPlay 粵語'; ctx.fillText(title, sbw + (CW-ctx.measureText(title).width)/2, H*0.18); ctx.font='18px system-ui'; ctx.fillStyle='#AFB6C3'; const sub='Lerne Kantonesisch spielerisch (auf Deutsch)'; ctx.fillText(sub, sbw + (CW-ctx.measureText(sub).width)/2, H*0.18+28);
    drawBadge(sbw+16,16,'🎯 Ziel: Hören • Sprechen • Sehen'); this.buttons.forEach(b=>{ b.hover=b.contains(pointer.x,pointer.y); b.draw(); }); ctx.fillStyle='#AFB6C3'; ctx.font='14px system-ui'; const tip='Tipp: Tippe auf 🔊, um die Aussprache zu hören.'; ctx.fillText(tip, sbw + (CW-ctx.measureText(tip).width)/2, H-20);
    drawBurgerMenu();
  }
  onPointer(type,p){ if(type==='down'){ const b=this.buttons.find(b=>b.contains(p.x,p.y)); if(b) b.onClick(); } }
}

class CardsOverviewScene extends Scene{ get id(){return 'cards';}
  constructor(){ super(); this.tileBoxes=[]; this.scrollY=0; this.contentHeight=0; this.pointerStart=null;}
  onScroll(deltaY) {
      const H = canvas.clientHeight;
      this.scrollY += deltaY;
      if (this.scrollY < 0) this.scrollY = 0;
      const maxScroll = Math.max(0, this.contentHeight - H);
      if (this.scrollY > maxScroll) this.scrollY = maxScroll;
  }
  draw(){ drawSidebar(this.id); const sbw=getActiveSidebarWidth(); const W=canvas.clientWidth, H=canvas.clientHeight; const CW=W-sbw; ctx.fillStyle='#AFB6C3'; ctx.font='14px system-ui'; ctx.fillText('🃏 Flashcards — Übersicht', sbw+16, 48);
    const cols = Math.max(1, Math.floor(CW/260)); const gap=16; const tileW = Math.min(240, (CW - (cols+1)*gap)/cols); const tileH= tileW*0.72 + 60; let x=sbw+gap, y=76; this.tileBoxes=[];
    ctx.save(); ctx.beginPath(); rrect(sbw, 0, CW, H, 0); ctx.clip(); ctx.translate(0, -this.scrollY);
    WORDS.forEach((w,i)=>{ if(x+tileW>sbw+CW-gap){ x=sbw+gap; y+=tileH+gap; } shadow(()=>{ ctx.fillStyle='rgba(255,255,255,0.06)'; rrect(x,y,tileW,tileH,18); ctx.fill(); }); const img=IMAGES[w.photo]; if(img&&img.complete){ const ar=img.width/img.height; let dw=tileW, dh=dw/ar; if(dh>tileH-60){ dh=tileH-60; dw=dh*ar; } const ix=x+(tileW-dw)/2, iy=y+(tileH-60-dh)/2; ctx.drawImage(img,ix,iy,dw,dh);} ctx.fillStyle='#e6ebf2'; ctx.font='18px system-ui'; ctx.fillText(w.yue, x+12, y+tileH-26); ctx.fillStyle='#AFB6C3'; ctx.font='14px system-ui'; ctx.fillText(w.de, x+12, y+tileH-8); this.tileBoxes.push({x,y,w:tileW,h:tileH,index:i}); x+=tileW+gap; });
    this.contentHeight = y + tileH + gap;
    ctx.restore();
    drawBurgerMenu();
  }
  onPointer(type,p){
      if (type==='down') { this.pointerStart = { x: p.x, y: p.y, scroll: this.scrollY }; }
      else if (type==='move' && pointer.down && this.pointerStart) { const dy = p.y - this.pointerStart.y; this.scrollY = this.pointerStart.scroll - dy; this.onScroll(0); }
      else if (type==='up' && this.pointerStart) {
          const dist = Math.hypot(p.x-this.pointerStart.x, p.y-this.pointerStart.y);
          if (dist < 10) {
              const hit=this.tileBoxes.find(b=> p.x>=b.x && p.x<=b.x+b.w && p.y>=b.y-this.scrollY && p.y<=b.y+b.h-this.scrollY );
              if(hit) setScene(new CardDetailScene(hit.index));
          }
          this.pointerStart = null;
      }
  }
}

class CardDetailScene extends Scene{ get id(){return 'cards';}
  constructor(index){ super(); this.i=index; this.hkBtn=new Button('中文 🇭🇰','',0,0,150,44,()=>speakYue(this.current().yue)); this.deBtn=new Button('Deutsch 🇩🇪','',0,0,170,44,()=>speakDe(this.current().de)); this.prevBtn=new Button('⬅️','',0,0,56,56,()=>this.prev()); this.nextBtn=new Button('➡️','',0,0,56,56,()=>this.next()); this.homeBtn=new Button('Zur Übersicht','📚',0,0,180,44,()=>setScene(new CardsOverviewScene())); this.layout(); speakYue(this.current().yue); }
  current(){ return WORDS[this.i]; }
  layout(){
    const sbw=getActiveSidebarWidth(); const W=canvas.clientWidth, H=canvas.clientHeight; const CW=W-sbw;
    const cardW=Math.min(640,CW*0.7), cardH=Math.min(420,H*0.55);
    const cardX=sbw + (CW-cardW)/2, cardY=(H-cardH)/2-20;
    this.prevBtn.x = cardX - this.prevBtn.w - 20;
    this.prevBtn.y = cardY + (cardH - this.prevBtn.h) / 2;
    this.nextBtn.x = cardX + cardW + 20;
    this.nextBtn.y = cardY + (cardH - this.nextBtn.h) / 2;
    const bottomY=H-64; const centerX=sbw+CW/2;
    this.hkBtn.x=centerX-170; this.hkBtn.y=bottomY;
    this.deBtn.x=centerX; this.deBtn.y=bottomY;
    this.homeBtn.x=W-196; this.homeBtn.y=16;
  }
  next(){ this.i=(this.i+1)%WORDS.length; speakYue(this.current().yue); }
  prev(){ this.i=(this.i-1+WORDS.length)%WORDS.length; speakYue(this.current().yue); }
  draw(){ drawSidebar(this.id); const sbw=getActiveSidebarWidth(); const W=canvas.clientWidth,H=canvas.clientHeight; const w=this.current(); ctx.fillStyle='#AFB6C3'; ctx.font='14px system-ui'; ctx.fillText(`🃏 Flashcards — ${this.i+1}/${WORDS.length}`, sbw+16, 48); const CW = W-sbw; const cardW=Math.min(640,CW*0.7), cardH=Math.min(420,H*0.55), x=sbw + (CW-cardW)/2, y=(H-cardH)/2-20; shadow(()=>{ ctx.fillStyle='rgba(255,255,255,0.06)'; rrect(x,y,cardW,cardH,26); ctx.fill();}); const img=IMAGES[w.photo]; if(img&&img.complete){ const ar=img.width/img.height; let dw=cardW, dh=dw/ar; if(dh>cardH){ dh=cardH; dw=dh*ar; } const ix=x+(cardW-dw)/2, iy=y+(cardH-dh)/2; ctx.drawImage(img,ix,iy,dw,dh);} ctx.fillStyle='#e6ebf2'; ctx.font='32px system-ui'; const yue=w.yue; ctx.fillText(yue, sbw + (CW-ctx.measureText(yue).width)/2, y+cardH+44); ctx.fillStyle='#AFB6C3'; ctx.font='20px system-ui'; const de=w.de; ctx.fillText(de, sbw + (CW-ctx.measureText(de).width)/2, y+cardH+72);
    [this.prevBtn,this.nextBtn,this.hkBtn,this.deBtn,this.homeBtn].forEach(b=>{ b.hover=b.contains(pointer.x,pointer.y); b.draw();});
    drawBurgerMenu();
  }
  onPointer(type,p){ if(type!=='down') return; [this.prevBtn,this.nextBtn,this.hkBtn,this.deBtn,this.homeBtn].forEach(b=>{ if(b.contains(p.x,p.y)) b.onClick(); }); }
  onKey(key) { if (key === 'ArrowLeft') this.prev(); if (key === 'ArrowRight') this.next(); if (key === 'Escape') setScene(new CardsOverviewScene()); }
}

class QuizScene extends Scene{ get id(){return 'quiz';}
  constructor(){ super(); this.correct=0; this.negTimer=0; this.steps=10; this.progress=0; this.hkBtn=new Button('中文 🇭🇰','',0,0,150,44,()=>speakYue(this.current.yue)); this.deBtn=new Button('Deutsch 🇩🇪','',0,0,170,44,()=>speakDe(this.current.de)); this.prepareQuestion(); this.layout(); }
  pickRand(except){ const pool=WORDS.filter(w=>w!==except); return pool[Math.floor(Math.random()*pool.length)]; }
  prepareQuestion(){ this.current = WORDS[Math.floor(Math.random()*WORDS.length)]; this.options=[this.current, this.pickRand(this.current), this.pickRand(this.current), this.pickRand(this.current)]; this.options = Array.from(new Set(this.options)); while(this.options.length<4) this.options.push(this.pickRand(this.current)); this.options.sort(()=>Math.random()-0.5); speakYue(this.current.yue); }
  layout(){
      const sbw=getActiveSidebarWidth(); const W=canvas.clientWidth,H=canvas.clientHeight; const CW=W-sbw;
      const bottomY = H-64; const centerX = sbw + CW / 2;
      this.hkBtn.x = centerX - 170; this.hkBtn.y = bottomY;
      this.deBtn.x = centerX; this.deBtn.y = bottomY;
  }
  draw(){ drawSidebar(this.id); const sbw=getActiveSidebarWidth(); const W=canvas.clientWidth,H=canvas.clientHeight; const CW=W-sbw; ctx.fillStyle='#AFB6C3'; ctx.font='14px system-ui'; ctx.fillText('🧠 Quiz — Höre und wähle das richtige Bild', sbw+16, 48);
    ctx.fillStyle='#e6ebf2'; ctx.font='26px system-ui'; const q=this.current.yue; ctx.fillText(q, sbw + (CW-ctx.measureText(q).width)/2, 92);
    
    const gap=18; const gridW=Math.min(CW-48, 800); const tileW=(gridW-gap)/2, tileH=Math.min(260, tileW*0.66);
    const gx=sbw + (CW - gridW)/2, gy=130;
    this.options.forEach((opt,i)=>{ const row=Math.floor(i/2), col=i%2; const x=gx + col*(tileW+gap), y=gy + row*(tileH+gap); shadow(()=>{ ctx.fillStyle='rgba(255,255,255,0.06)'; rrect(x,y,tileW,tileH,18); ctx.fill();}); const img=IMAGES[opt.photo]; if(img&&img.complete){ const ar=img.width/img.height; let dw=tileW, dh=dw/ar; if(dh>tileH){ dh=tileH; dw=dh*ar; } const ix=x+(tileW-dw)/2, iy=y+(tileH-dh)/2; ctx.drawImage(img,ix,iy,dw,dh);} opt._box={x,y,w:tileW,h:tileH}; });

    const gridBottom = gy + 2*tileH + gap;
    const trackY = gridBottom + 40;
    const trackX=sbw+60, trackW=CW-120, trackH=18;
    shadow(()=>{ ctx.fillStyle='rgba(255,255,255,0.08)'; rrect(trackX,trackY,trackW,trackH,12); ctx.fill();});
    const stepW=trackW/this.steps; ctx.fillStyle='#22d3ee'; rrect(trackX,trackY, Math.max(0,(this.progress)*stepW), trackH,12); ctx.fill();
    ctx.font='28px system-ui'; ctx.fillText('🐭', trackX + Math.max(0,(this.progress-0.9))*stepW, trackY+trackH+4);
    ctx.fillText('🧀', trackX + trackW-6, trackY+trackH+4);
    
    [this.hkBtn, this.deBtn].forEach(b => { b.hover = b.contains(pointer.x, pointer.y); b.draw(); });
    ctx.fillStyle='#AFB6C3'; ctx.font='16px system-ui'; ctx.fillText(`✅ ${this.correct} richtig`, sbw+16, H-16);
    if(this.negTimer>0){ ctx.globalAlpha=Math.min(0.25,this.negTimer/20); ctx.fillStyle='#ef4444'; rrect(gx-10,gy-10,gridW+20,gridBottom-gy+10,24); ctx.fill(); ctx.globalAlpha=1; this.negTimer--; }
    drawParticles();
    drawBurgerMenu();
  }
  onPointer(type,p){
      if(type!=='down') return;
      if(this.hkBtn.contains(p.x, p.y)) { this.hkBtn.onClick(); return; }
      if(this.deBtn.contains(p.x, p.y)) { this.deBtn.onClick(); return; }

      const hit=this.options.find(o=> p.x>=o._box.x && p.x<=o._box.x+o._box.w && p.y>=o._box.y && p.y<=o._box.y+o._box.h );
      if(!hit) return;
      if(hit===this.current){ this.correct++; this.progress=Math.min(this.steps,this.progress+1); const cx=hit._box.x+hit._box.w/2, cy=hit._box.y+hit._box.h/2; emitConfetti(cx,cy,'#22c55e',42); emitConfetti(cx,cy,'#8b5cf6',28); emitConfetti(cx,cy,'#22d3ee',28); fxPositive(); if(this.progress>=this.steps){ this.showWin(); } else { setTimeout(()=>this.prepareQuestion(), 300); } }
      else { this.progress=Math.max(0,this.progress-1); this.negTimer=14; fxNegative(); emitConfetti(p.x,p.y,'#ef4444',10); }
  }
  onKey(key){ if(key==='Escape') setScene(new HomeScene()); if(key===' ') speakYue(this.current.yue); }
  showWin(){ const W=canvas.clientWidth, H=canvas.clientHeight; const sbw=getActiveSidebarWidth(); for(let i=0;i<120;i++){ emitConfetti(sbw+Math.random()*(W-sbw), 140+Math.random()*(H-240), ['#22c55e','#8b5cf6','#22d3ee'][i%3],1); } fxPositive(); fxPositive(); const msg1='Super! Du hast die Käsejagd geschafft!'; const msg2='好叻呀！你攞到芝士啦！'; setTimeout(()=>{ alert(`${msg1}\n${msg2}`); this.correct=0; this.progress=0; this.prepareQuestion(); }, 1200); }
}

class MouseCheeseScene extends Scene{ get id(){return 'game';}
  constructor(){ super(); this.grid=72; this.speed=5; this.margin=40; this.lastMove=0; this.dir={x:1,y:0}; this.pendingDir=this.dir; this.layout(); this.reset(); }
  layout(){
      const W=canvas.clientWidth, H=canvas.clientHeight;
      const size = 80, gap = 10, safe = 60;
      const cx = W - size * 1.5 - gap - safe;
      const cy = H - size * 1.5 - gap - safe;
      this.dpad = { up: { x: cx, y: cy - size - gap, w: size, h: size }, left: { x: cx - size - gap, y: cy, w: size, h: size }, right: { x: cx + size + gap, y: cy, w: size, h: size }, down: { x: cx, y: cy + size + gap, w: size, h: size } };
      this.dpad.bounds = { x: cx-size-gap, y: cy-size-gap, w: (size*3+gap*2), h:(size*3+gap*2)};
  }
  playArea(){
      const sbw=getActiveSidebarWidth(); const W=canvas.clientWidth, H=canvas.clientHeight;
      let right = W-this.margin;
      if (W > (sbw + this.dpad.bounds.w + 2 * this.margin)) {
          right = this.dpad.bounds.x - this.margin;
      }
      const left=sbw+this.margin, top=120, bottom=H-this.margin;
      return {left,top,right,bottom,width:right-left,height:bottom-top};
  }
  reset(){ const a=this.playArea(); this.cols=Math.max(1, Math.floor(a.width/this.grid)); this.rows=Math.max(1, Math.floor(a.height/this.grid)); const cx=Math.floor(this.cols/2), cy=Math.floor(this.rows/2); this.body=[{x:cx,y:cy}]; this.placeCheese(); this.score=0; this.wordIndex=0; this.wordOrder=shuffle([...WORDS]); }
  placeCheese(){ this.cheese={x:Math.floor(Math.random()*this.cols), y:Math.floor(Math.random()*this.rows)}; if(this.body.some(s=>s.x===this.cheese.x && s.y===this.cheese.y)) this.placeCheese(); }
  drawGrid(){ const a=this.playArea(); ctx.strokeStyle='rgba(255,255,255,0.05)'; ctx.lineWidth=1; for(let x=0;x<=this.cols;x++){ ctx.beginPath(); ctx.moveTo(a.left+x*this.grid, a.top); ctx.lineTo(a.left+x*this.grid, a.bottom); ctx.stroke(); } for(let y=0;y<=this.rows;y++){ ctx.beginPath(); ctx.moveTo(a.left, a.top+y*this.grid); ctx.lineTo(a.right, a.top+y*this.grid); ctx.stroke(); } }
  draw(){ drawSidebar(this.id); const sbw=getActiveSidebarWidth(); const W=canvas.clientWidth, H=canvas.clientHeight; const a=this.playArea(); ctx.fillStyle='#AFB6C3'; ctx.font='14px system-ui'; ctx.fillText('🐭 Maus & Käse — Pfeiltasten oder Touch-Controller', sbw+16, 48);
    const word=this.wordOrder[this.wordIndex % this.wordOrder.length]; const bannerW=Math.min(560,(W-sbw-60)), bannerH=56, bx=sbw + ((W-sbw)-bannerW)/2, by=56; shadow(()=>{ ctx.fillStyle='rgba(255,255,255,0.06)'; rrect(bx,by,bannerW,bannerH,18); ctx.fill(); }); ctx.fillStyle='#e6ebf2'; ctx.font='20px system-ui'; const line=`🧀 Nächster Käse sagt: ${word.yue}  (${word.de})`; ctx.fillText(line, bx+16, by+36);
    this.drawGrid();
    ctx.font = `${this.grid}px system-ui`; ctx.fillText('🧀', a.left + this.cheese.x*this.grid + 4, a.top + this.cheese.y*this.grid + this.grid - 6);
    this.body.forEach((s,i)=>{ if(i===0){ ctx.font=`${this.grid+4}px system-ui`; ctx.fillText('🐭', a.left + s.x*this.grid + 2, a.top + s.y*this.grid + this.grid - 4); } else { ctx.fillStyle='rgba(255,255,255,0.5)'; rrect(a.left + s.x*this.grid+6, a.top + s.y*this.grid+6, this.grid-12, this.grid-12, 6); ctx.fill(); } });
    ctx.fillStyle='#AFB6C3'; ctx.font='16px system-ui'; ctx.fillText(`Punkte: ${this.score}`, sbw+16, H-16);
    this.drawDpad();
    drawBurgerMenu();
  }
  drawDpad(){
    Object.entries(this.dpad).forEach(([key, box])=>{
      if (key === 'bounds') return;
      const labels = { up: '⬆️', left: '⬅️', right: '➡️', down: '⬇️' };
      shadow(()=>{ ctx.fillStyle=gradient(box.x,box.y,box.w,box.h,'#334155','#475569'); rrect(box.x,box.y,box.w,box.h,16); ctx.fill();});
      ctx.fillStyle='#fff'; ctx.font='34px system-ui'; const tw=ctx.measureText(labels[key]).width; ctx.fillText(labels[key], box.x+(box.w-tw)/2, box.y+box.h/2+12);
    });
  }
  step(){ const now=performance.now(); if(now-this.lastMove < (1000/this.speed)) return; this.lastMove=now; const head={x:this.body[0].x+this.pendingDir.x, y:this.body[0].y+this.pendingDir.y};
    head.x=(head.x+this.cols)%this.cols; head.y=(head.y+this.rows)%this.rows;
    if(this.body.some((s,i)=> i>0 && s.x===head.x && s.y===head.y)){ const a=this.playArea(); emitConfetti(a.left+40,a.top+40,'#ef4444'); this.reset(); return; }
    this.dir=this.pendingDir; this.body.unshift(head);
    if(head.x===this.cheese.x && head.y===this.cheese.y){ this.score++; const a=this.playArea(); emitConfetti(a.left + (head.x+0.5)*this.grid, a.top + (head.y+0.5)*this.grid,'#22c55e',28); const w=this.wordOrder[this.wordIndex % this.wordOrder.length]; speakYue(w.yue); this.wordIndex++; this.placeCheese(); } else { this.body.pop(); }
  }
  onPointer(type,p){ if(type!=='down') return; const hit=Object.entries(this.dpad).find(([k,b])=> k !== 'bounds' && p.x>=b.x && p.x<=b.x+b.w && p.y>=b.y && p.y<=b.y+b.h); if(hit){ const k=hit[0]; if(k==='up' && this.dir.y!==1) this.pendingDir={x:0,y:-1}; if(k==='down'&& this.dir.y!==-1) this.pendingDir={x:0,y:1}; if(k==='left'&& this.dir.x!==1) this.pendingDir={x:-1,y:0}; if(k==='right'&& this.dir.x!==-1) this.pendingDir={x:1,y:0}; } }
  onKey(key){ if(key==='ArrowUp' && this.dir.y!==1) this.pendingDir={x:0,y:-1}; if(key==='ArrowDown'&& this.dir.y!==-1) this.pendingDir={x:0,y:1}; if(key==='ArrowLeft'&& this.dir.x!==1) this.pendingDir={x:-1,y:0}; if(key==='ArrowRight'&& this.dir.x!==-1) this.pendingDir={x:1,y:0}; if(key==='Escape') setScene(new HomeScene()); if(key===' ') { const w=this.wordOrder[this.wordIndex % this.wordOrder.length]; speakYue(w.yue);} }
}

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

// ========= App Loop =========
let last=0; function loop(ts){ const dt=(ts-last)/1000; last=ts; ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
  const W=canvas.clientWidth,H=canvas.clientHeight; const g=ctx.createRadialGradient(W*0.5,H*0.1,120,W*0.5,H*0.6,Math.max(W,H)); g.addColorStop(0,'rgba(139,92,246,0.06)'); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  if(activeScene instanceof MouseCheeseScene) activeScene.step(); activeScene?.draw(dt); updateParticles(dt); drawParticles(); requestAnimationFrame(loop); }

function setScene(s){ activeScene=s; }

(async function start(){
  await Promise.all([loadImages(), ensureVoicesReady()]);
  setScene(new HomeScene());
  requestAnimationFrame(loop);
})();

</script>
</body>
</html>