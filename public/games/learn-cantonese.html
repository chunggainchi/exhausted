<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Cantonese Mouse & Magic</title>
  <style>
    html, body { margin:0; height:100%; background:#ffeef8; overflow:hidden; }
    canvas { display:block; width:100vw; height:100vh; }
  </style>
</head>
<body>
  <canvas id="app"></canvas>
  <script>
  // =============================================================
  //  CANTONESE MOUSE & MAGIC — CLEAN BASELINE (NO STRAY CODE)
  //  All drawing is on <canvas>. No external fonts. Robust to CSP.
  // =============================================================

  // ====== Canvas & sizing ======
  const canvas = document.getElementById('app');
  const ctx = canvas.getContext('2d');
  let W=0,H=0,DPR=1;
  function resize(){
    DPR = Math.min(window.devicePixelRatio||1, 2);
    W = Math.floor(window.innerWidth * DPR);
    H = Math.floor(window.innerHeight * DPR);
    canvas.width = W; canvas.height = H;
  }
  window.addEventListener('resize', resize);
  resize();

  // ====== Helpful globals ======
  const PINK = '#ff69b4', LILAC='#b388ff', GOLD='#ffd54f';
  const hits=[]; // clickable regions per frame
  function addHit(id,x,y,w,h,onClick){ hits.push({id,x,y,w,h,onClick}); }
  function inRect(mx,my,r){ return mx>=r.x && mx<=r.x+r.w && my>=r.y && my<=r.y+r.h; }
  const input={ tap:false, x:0, y:0 };
  function toCanvas(e){ const r=canvas.getBoundingClientRect(); return {x:(e.clientX-r.left)*(W/r.width), y:(e.clientY-r.top)*(H/r.height)}; }
  canvas.addEventListener('pointerdown', e=>{ const p=toCanvas(e); input.x=p.x; input.y=p.y; input.tap=true; });

  // ====== Utility drawing ======
  function roundRect(x,y,w,h,r, fill=true, stroke=false){ const rr=Math.min(r,w/2,h/2); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); if(fill) ctx.fill(); if(stroke) ctx.stroke(); }
  function button({x,y,w,h,label,bg='#fff'}){ ctx.save(); ctx.shadowColor='rgba(0,0,0,0.14)'; ctx.shadowBlur=12*DPR; ctx.shadowOffsetY=6*DPR; ctx.fillStyle=bg; roundRect(x,y,w,h,24*DPR,true,false); ctx.restore(); ctx.fillStyle='#5a4b57'; ctx.font=`${Math.floor(h*0.3)}px system-ui, Arial`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(label, x+w/2, y+h/2); }
  function drawTitle(t,y){ ctx.fillStyle='#5a4b57'; ctx.font=`${Math.floor(44*DPR)}px system-ui, Arial`; ctx.textAlign='center'; ctx.fillText(t, W/2, y); }
  function drawProgressRing(x,y,r, value, max){ const p=Math.min(1,value/max); ctx.save(); ctx.lineWidth=r*0.18; ctx.strokeStyle='#ffd1f5'; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.stroke(); ctx.strokeStyle='#ff8ab6'; ctx.beginPath(); ctx.arc(x,y,r, -Math.PI/2, -Math.PI/2 + Math.PI*2*p); ctx.stroke(); ctx.restore(); }

  // ====== Background glitter ======
  const sparkles=[]; function addSparkles(x,y,n=12){ for(let i=0;i<n;i++){ sparkles.push({x,y,vx:(Math.random()-0.5)*1.2,vy:(Math.random()-0.5)*1.2,a:1,r:1+Math.random()*2,life:80}); } }
  function drawSparkles(){ for(let i=sparkles.length-1;i>=0;i--){ const s=sparkles[i]; s.x+=s.vx; s.y+=s.vy; s.life--; s.a=Math.max(0,s.life/80); ctx.save(); ctx.globalAlpha=s.a; ctx.fillStyle=i%2?GOLD:'#fff'; ctx.beginPath(); ctx.arc(s.x,s.y,s.r*DPR,0,Math.PI*2); ctx.fill(); ctx.restore(); if(s.life<=0) sparkles.splice(i,1);} }
  function drawBackground(){ const gx=W*0.7, gy=H*0.2, r=Math.max(W,H); const g=ctx.createRadialGradient(gx,gy,r*0.05,gx,gy,r); g.addColorStop(0,'#ffe0f2'); g.addColorStop(0.4,'#ffd1ec'); g.addColorStop(0.65,'#ffc6e9'); g.addColorStop(1,'#ffdff2'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H); }

  // ====== Speech (safe) ======
  const Voice={ voices:[], ready:false,
    init(){ const load=()=>{ const vs=speechSynthesis.getVoices(); if(vs&&vs.length){ this.voices=vs; this.ready=true; } }; speechSynthesis.onvoiceschanged=load; load(); },
    pick(locs){ if(!this.ready) return null; for(const loc of locs){ const v=this.voices.find(v=> (v.lang||'').toLowerCase().includes(loc.toLowerCase())); if(v) return v; } return this.voices[0]||null; },
    speak(text, locs=['yue-hk','zh-hk','zh-hant','zh-tw','zh-cn']){ try{ const u=new SpeechSynthesisUtterance(text); const v=this.pick(locs); if(v) u.voice=v; u.rate=0.9; u.pitch=1.1; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(_){} },
    de(text){ this.speak(text, ['de-de','de']); }
  }; Voice.init();

  // ====== Data ======
  const WORDS=[
    {id:'hello', photo:'hello', yue:'你好', de:'Hallo'},
    {id:'thanks', photo:'thanks', yue:'多謝', de:'Danke'},
    {id:'toilet', photo:'toilet', yue:'洗手間喺邊？', de:'Wo ist die Toilette?'},
    {id:'hungry', photo:'hungry', yue:'我肚餓', de:'Ich habe Hunger'},
    {id:'thirsty', photo:'thirsty', yue:'我口渴', de:'Ich habe Durst'},
    {id:'rice', photo:'rice', yue:'白飯', de:'Reis'},
    {id:'noodles', photo:'noodles', yue:'麵', de:'Nudeln'},
    {id:'dumpling', photo:'dumpling', yue:'餃子', de:'Dumpling'},
    {id:'yummy', photo:'yummy', yue:'好味', de:'Lecker'},
    {id:'full', photo:'full', yue:'我食飽啦', de:'Ich bin satt'},
    {id:'sorry', photo:'sorry', yue:'唔好意思', de:'Entschuldigung'},
    {id:'where', photo:'where', yue:'喺邊度？', de:'Wo?'},
    {id:'grandma', photo:'grandma', yue:'婆婆/嫲嫲你好', de:'Hallo Oma'},
    {id:'grandpa', photo:'grandpa', yue:'公公/爺爺你好', de:'Hallo Opa'},
    {id:'aunt', photo:'aunt', yue:'姨姨你好', de:'Hallo Tante'},
    {id:'friend', photo:'friend', yue:'我哋做朋友啦', de:'Lass uns Freunde sein'},
    {id:'play', photo:'play', yue:'一齊玩', de:'Zusammen spielen'},
    {id:'buy', photo:'buy', yue:'我想買呢個', de:'Ich möchte das kaufen'},
    {id:'howmuch', photo:'howmuch', yue:'幾多錢？', de:'Wie viel kostet das?'},
    {id:'bus', photo:'bus', yue:'巴士站喺邊？', de:'Wo ist die Bushaltestelle?'},
    {id:'train', photo:'train', yue:'地鐵站', de:'U‑Bahn/MTR'},
    {id:'taxi', photo:'taxi', yue:'的士', de:'Taxi'},
    {id:'hot', photo:'hot', yue:'好熱', de:'Heiß'},
    {id:'cold', photo:'cold', yue:'好凍', de:'Kalt'},
    {id:'help', photo:'help', yue:'幫下手', de:'Hilf mir bitte'},
    {id:'toilet2', photo:'toilet', yue:'我要去洗手間', de:'Ich muss aufs Klo'},
    {id:'bye', photo:'bye', yue:'拜拜', de:'Tschüss'},
    {id:'pink', photo:'pink', yue:'粉紅色', de:'Rosa'},
    {id:'unicorn', photo:'unicorn', yue:'獨角獸', de:'Einhorn'}
  ];
  const PHOTO_URLS={
    hello:'https://images.unsplash.com/photo-1517841905240-472988babdf9?w=1000&auto=format&fit=crop',
    thanks:'https://images.unsplash.com/photo-1520975693410-001d3a6f6c5d?w=1000&auto=format&fit=crop',
    toilet:'https://images.unsplash.com/photo-1588771930290-24c1db7a2c2b?w=1000&auto=format&fit=crop',
    hungry:'https://images.unsplash.com/photo-1504754524776-8f4f37790ca0?w=1000&auto=format&fit=crop',
    thirsty:'https://images.unsplash.com/photo-1548839140-29a75f3f3a02?w=1000&auto=format&fit=crop',
    rice:'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=1000&auto=format&fit=crop',
    noodles:'https://images.unsplash.com/photo-1544025162-d76694265947?w=1000&auto=format&fit=crop',
    dumpling:'https://images.unsplash.com/photo-1598866594230-3b4c2a8e85b7?w=1000&auto=format&fit=crop',
    yummy:'https://images.unsplash.com/photo-1492724441997-5dc865305da7?w=1000&auto=format&fit=crop',
    full:'https://images.unsplash.com/photo-1526318472351-c75fcf070305?w=1000&auto=format&fit=crop',
    sorry:'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?w=1000&auto=format&fit=crop',
    where:'https://images.unsplash.com/photo-1502920917128-1aa500764ce7?w=1000&auto=format&fit=crop',
    grandma:'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?w=1000&auto=format&fit=crop',
    grandpa:'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=1000&auto=format&fit=crop',
    aunt:'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?w=1000&auto=format&fit=crop',
    friend:'https://images.unsplash.com/photo-1503454537195-1dcabb73ffb9?w=1000&auto=format&fit=crop',
    play:'https://images.unsplash.com/photo-1504319583580-b0be24b40e76?w=1000&auto=format&fit=crop',
    buy:'https://images.unsplash.com/photo-1521335629791-ce4aec67dd53?w=1000&auto=format&fit=crop',
    howmuch:'https://images.unsplash.com/photo-1554224155-1696413565d3?w=1000&auto=format&fit=crop',
    bus:'https://images.unsplash.com/photo-1508479476517-4a66f0a11106?w=1000&auto=format&fit=crop',
    train:'https://images.unsplash.com/photo-1477414348463-c0eb7f1359b6?w=1000&auto=format&fit=crop',
    taxi:'https://images.unsplash.com/photo-1541529086526-c86f6e0a5a0f?w=1000&auto=format&fit=crop',
    hot:'https://images.unsplash.com/photo-1501973801540-537f08ccae7b?w=1000&auto=format&fit=crop',
    cold:'https://images.unsplash.com/photo-1519681393784-d120267933ba?w=1000&auto=format&fit=crop',
    help:'https://images.unsplash.com/photo-1511988617509-a57c8a288659?w=1000&auto=format&fit=crop',
    bye:'https://images.unsplash.com/photo-1511988617509-a57c8a288659?w=1000&auto=format&fit=crop',
    pink:'https://images.unsplash.com/photo-1541560052-77ec1bbc09f7?w=1000&auto=format&fit=crop',
    unicorn:'https://images.unsplash.com/photo-1519681393784-d120267933ba?w=1000&auto=format&fit=crop'
  };
  const ImgCache=new Map();
  function getImage(key){ const url=PHOTO_URLS[key]||key; if(!url) return null; if(ImgCache.has(url)) return ImgCache.get(url); const img=new Image(); img.crossOrigin='anonymous'; img.src=url; ImgCache.set(url,img); return img; }
  function roundedClip(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); ctx.clip(); }
  function drawPhoto(key,x,y,w,h,r=22*DPR){ const img=getImage(key); if(img&&img.complete&&img.naturalWidth>0){ ctx.save(); roundedClip(x,y,w,h,r); ctx.drawImage(img,x,y,w,h); ctx.restore(); } else { ctx.save(); ctx.fillStyle='#ffffffcc'; roundRect(x,y,w,h,r,true,false); ctx.restore(); ctx.fillStyle='#5a4b57'; ctx.font=`${Math.floor(18*DPR)}px system-ui`; ctx.textAlign='center'; ctx.fillText('Foto lädt…', x+w/2, y+h/2); } }

  // ====== Progress (localStorage) ======
  const STORAGE_KEY='canto_mouse_magic_clean_v2';
  const Progress={data:{streak:0,lastDay:null,perDay:{}}, today(){return new Date().toISOString().slice(0,10);},
    load(){ try{ const raw=localStorage.getItem(STORAGE_KEY); if(raw) this.data=JSON.parse(raw);}catch(_){ } this.ensure(); },
    ensure(){ const t=this.today(); if(this.data.lastDay!==t){ if(this.data.lastDay){ const d=(new Date(t)-new Date(this.data.lastDay))/86400000; this.data.streak = d===1? (this.data.streak||0)+1 : 1; } else { this.data.streak=1; } this.data.lastDay=t; this.data.perDay[t]=this.data.perDay[t]||{words:0,quiz:0,cheese:0}; this.save(); } },
    bump(k){ this.ensure(); const d=this.data.perDay[this.today()]; d[k]=(d[k]||0)+1; this.save(); },
    todayData(){ this.ensure(); return this.data.perDay[this.today()]; },
    save(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(this.data)); }catch(_){ } }
  }; Progress.load();

  // ====== UI State ======
  const ui={ mode:'home', flash:{view:'overview', selected:0} };

  // ====== Navbar ======
  function drawNavBar(title, back){ const h=90*DPR; ctx.fillStyle='#ffd1f5'; roundRect(20*DPR,20*DPR,W-40*DPR,h,24*DPR,true,false); button({x:40*DPR,y:35*DPR,w:160*DPR,h:60*DPR,label:'Zurück',bg:'#ffecf7'}); addHit('back',40*DPR,35*DPR,160*DPR,60*DPR,()=>back&&back()); ctx.fillStyle='#5a4b57'; ctx.font=`${Math.floor(34*DPR)}px system-ui`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(title, W/2, 20*DPR + h/2); }

  // ====== Home Screen ======
  function drawHome(){ hits.length=0; // header
    ctx.fillStyle='#ffc2e0'; roundRect(0,0,W,100*DPR,0,true,false); drawTitle('Cantonese Mouse & Magic', 70*DPR);
    const t=Progress.todayData(); const xp=(t.words||0)+(t.quiz||0)*2+(t.cheese||0); const target=10;
    ctx.fillStyle='#fff6fb'; roundRect(W*0.5-220*DPR, 120*DPR, 440*DPR, 120*DPR, 24*DPR, true, false);
    drawProgressRing(W/2, 180*DPR, 50*DPR, xp, target);
    ctx.fillStyle='#5a4b57'; ctx.font=`${Math.floor(20*DPR)}px system-ui`; ctx.textAlign='center';
    ctx.fillText(`Heutiger Zauber: ${xp}/${target}`, W/2, 150*DPR);
    ctx.fillText(`Streak: ${Progress.data.streak} Tage`, W/2, 210*DPR);

    const bw=Math.min(300*DPR, W*0.28), bh=Math.min(160*DPR, H*0.2), gap=Math.min(40*DPR, W*0.05);
    let x=(W-(bw*3+gap*2))/2, y=Math.max(280*DPR, H*0.42);
    button({x,y,w:bw,h:bh,label:'Karten',bg:'#ffb3d4'}); addHit('toFlash',x,y,bw,bh,()=>{ ui.mode='flash'; ui.flash.view='overview'; }); x+=bw+gap;
    button({x,y,w:bw,h:bh,label:'Quiz',bg:'#b8f4e7'}); addHit('toQuiz',x,y,bw,bh,()=>{ ui.mode='quiz'; quizQ=null; }); x+=bw+gap;
    button({x,y,w:bw,h:bh,label:'Maus & Käse',bg:'#cfc3ff'}); addHit('toSnake',x,y,bw,bh,()=>{ resetSnake(); ui.mode='snake'; });
    ctx.fillStyle='#5a4b57'; ctx.font=`${Math.floor(16*DPR)}px system-ui`; ctx.fillText('Tippe einen Button, um zu starten ✨', W/2, H-30*DPR);
  }

  // ====== Flashcards ======
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function drawFlashcards(){ if(ui.flash.view==='overview') drawFlashOverview(); else drawFlashDetail(); }
  function drawFlashOverview(){ hits.length=0; drawNavBar('Karten',()=>ui.mode='home'); const pad=40*DPR, cardW=Math.min(280*DPR, W*0.22), cardH=Math.min(240*DPR, H*0.24), gap=Math.min(28*DPR, W*0.03); let x=pad, y=H*0.22; for(let i=0;i<WORDS.length;i++){ const it=WORDS[i]; if(x+cardW>W-pad){ x=pad; y+=cardH+60*DPR; } // bilingual caption above photo
      ctx.fillStyle='#5a4b57'; ctx.font=`${Math.floor(18*DPR)}px system-ui`; ctx.textAlign='center'; ctx.fillText(`${it.yue}  /  ${it.de}`, x+cardW/2, y-12*DPR);
      drawPhoto(it.photo, x, y, cardW, cardH, 22*DPR);
      addHit('flash_'+i, x,y,cardW,cardH, ()=>{ ui.flash.selected=i; ui.flash.view='detail'; addSparkles(x+cardW/2, y+cardH/2, 18); });
      x += cardW + gap; }
  }
  function drawFlashDetail(){ hits.length=0; const i=ui.flash.selected, item=WORDS[i]; drawNavBar('Karte',()=>{ ui.flash.view='overview'; }); const headerW=Math.min(W*0.82, 980*DPR), headerH=120*DPR, hx=(W-headerW)/2, hy=H*0.18; ctx.fillStyle='#fff6fb'; roundRect(hx,hy,headerW,headerH,24*DPR,true,false); ctx.fillStyle='#5a4b57'; ctx.font=`${Math.floor(38*DPR)}px system-ui`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(`${item.yue}  🇭🇰`, W/2, hy+headerH*0.35); ctx.font=`${Math.floor(26*DPR)}px system-ui`; ctx.fillText(`${item.de}  🇩🇪`, W/2, hy+headerH*0.75); const areaW=Math.min(W*0.78, 900*DPR), areaH=Math.min(H*0.5, 460*DPR), x=(W-areaW)/2, y=hy+headerH+20*DPR; drawPhoto(item.photo, x,y,areaW,areaH, 28*DPR); const bw=240*DPR,bh=90*DPR,gap=40*DPR,cx=W/2, by=y+areaH+30*DPR; button({x:cx-bw-gap/2,y:by,w:bw,h:bh,label:'中文 🇭🇰',bg:'#ffe6f3'}); addHit('speak_cn', cx-bw-gap/2, by, bw, bh, ()=>{ Voice.speak(item.yue); Progress.bump('words'); }); button({x:cx+gap/2,y:by,w:bw,h:bh,label:'Deutsch 🇩🇪',bg:'#dff8f0'}); addHit('speak_de', cx+gap/2, by, bw, bh, ()=>{ Voice.de(item.de); }); const nbw=160*DPR, nby=by+bh+16*DPR; button({x:cx-nbw-20*DPR,y:nby,w:nbw,h:70*DPR,label:'Zurück',bg:'#e9deff'}); addHit('prev', cx-nbw-20*DPR, nby, nbw, 70*DPR, ()=>{ ui.flash.selected=(i-1+WORDS.length)%WORDS.length; }); button({x:cx+20*DPR,y:nby,w:nbw,h:70*DPR,label:'Weiter',bg:'#e9deff'}); addHit('next', cx+20*DPR, nby, nbw, 70*DPR, ()=>{ ui.flash.selected=(i+1)%WORDS.length; }); }

  // ====== Quiz ======
  let quizQ=null, quizChoices=[];
  function newQuiz(){ const items=shuffle([...WORDS]).slice(0,3); quizChoices=items; quizQ=items[Math.floor(Math.random()*items.length)]; Voice.speak(quizQ.yue); }
  function drawQuiz(){ hits.length=0; if(!quizQ) newQuiz(); drawNavBar('Quiz',()=>ui.mode='home'); ctx.fillStyle='#5a4b57'; ctx.font=`${Math.floor(32*DPR)}px system-ui`; ctx.textAlign='center'; ctx.fillText(`Was ist:  ${quizQ.yue}`, W/2, H*0.18); const bw=Math.min(W*0.25, 320*DPR), bh=Math.min(H*0.32, 260*DPR), gap=Math.min(60*DPR, W*0.04); let x=(W-(bw*3+gap*2))/2, y=H*0.3; for(let i=0;i<3;i++){ const it=quizChoices[i]; drawPhoto(it.photo, x,y,bw,bh, 28*DPR); addHit('quiz'+i, x,y,bw,bh, ()=>{ const ok = (it.id===quizQ.id); addSparkles(x+bw/2, y+bh/2, 20); if(ok){ Progress.bump('quiz'); setTimeout(()=>newQuiz(), 700); } }); x+=bw+gap; } const ax=W*0.5-220*DPR, ay=H*0.68; button({x:ax,y:ay,w:200*DPR,h:90*DPR,label:'🔊 Kantonesisch',bg:'#ffe6f3'}); addHit('quizAudio', ax,ay,200*DPR,90*DPR, ()=>Voice.speak(quizQ.yue)); button({x:ax+220*DPR,y:ay,w:200*DPR,h:90*DPR,label:'💡 Hinweis (DE)',bg:'#dff8f0'}); addHit('quizHint', ax+220*DPR, ay, 200*DPR, 90*DPR, ()=>Voice.de(quizQ.de)); }

  // ====== Snake game ======
  const snake={grid:{cols:24, rows:18, size:28*DPR}, dir:{x:1,y:0}, speed:8, acc:0.02, t:0, body:[], cheese:{x:5,y:5}, playing:false, wordIndex:0};
  function resetSnake(){ const g=snake.grid; const cx=Math.floor(g.cols/2), cy=Math.floor(g.rows/2); snake.body=[{x:cx,y:cy},{x:cx-1,y:cy}]; snake.dir={x:1,y:0}; snake.speed=8; snake.t=0; placeCheese(); snake.playing=true; }
  function placeCheese(){ const g=snake.grid; let p; do{ p={x:Math.floor(Math.random()*g.cols), y:Math.floor(Math.random()*g.rows)}; } while(snake.body.some(b=>b.x===p.x && b.y===p.y)); snake.cheese=p; }
  function drawCheese(cx,cy,s){ ctx.save(); ctx.fillStyle=GOLD; ctx.beginPath(); ctx.moveTo(cx-s*0.5, cy+s*0.3); ctx.lineTo(cx+s*0.3, cy+s*0.3); ctx.lineTo(cx+s*0.5, cy-s*0.2); ctx.lineTo(cx-s*0.3, cy-s*0.2); ctx.closePath(); ctx.fill(); ctx.restore(); }
  function drawMouseSegment(cx,cy,s,dir){ ctx.save(); ctx.fillStyle='#fff'; ctx.strokeStyle='#ff99c9'; ctx.lineWidth=4; ctx.beginPath(); ctx.arc(cx,cy,s*0.42,0,Math.PI*2); ctx.fill(); ctx.stroke(); if(dir){ const ang = dir.x===1?0: dir.x===-1?Math.PI: dir.y===1?Math.PI/2:-Math.PI/2; ctx.translate(cx,cy); ctx.rotate(ang); ctx.fillStyle='#ffd1f5'; ctx.beginPath(); ctx.arc(-s*0.15,-s*0.3,s*0.12,0,Math.PI*2); ctx.arc(s*0.15,-s*0.3,s*0.12,0,Math.PI*2); ctx.fill(); ctx.fillStyle=PINK; ctx.beginPath(); ctx.arc(s*0.42,0,s*0.08,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#333'; ctx.beginPath(); ctx.arc(s*0.15,-s*0.05,s*0.07,0,Math.PI*2); ctx.fill(); } ctx.restore(); }
  let lastTime=0; function stepSnake(ox,oy){ const now=performance.now(); const dt=Math.min(40, now-(lastTime||now)); lastTime=now; if(!snake.playing) return; snake.t += dt*(snake.speed/140); if(snake.t>=1){ snake.t=0; const head={...snake.body[0]}; head.x+=snake.dir.x; head.y+=snake.dir.y; const g=snake.grid; if(head.x<0) head.x=g.cols-1; if(head.y<0) head.y=g.rows-1; if(head.x>=g.cols) head.x=0; if(head.y>=g.rows) head.y=0; if(snake.body.some((b,i)=>i>2 && b.x===head.x && b.y===head.y)){ snake.playing=false; return; } snake.body.unshift(head); if(head.x===snake.cheese.x && head.y===snake.cheese.y){ const word=WORDS[snake.wordIndex % WORDS.length]; snake.wordIndex++; Voice.speak(word.yue); Progress.bump('cheese'); addSparkles(ox+head.x*g.size+g.size/2, oy+head.y*g.size+g.size/2, 20); placeCheese(); snake.speed=Math.min(16, snake.speed+snake.acc); } else { snake.body.pop(); } } }
  function drawSnake(){ hits.length=0; drawNavBar('Maus & Käse', ()=>ui.mode='home'); const g=snake.grid; const gw=g.cols*g.size, gh=g.rows*g.size; const ox=(W-gw)/2, oy=H*0.18; ctx.fillStyle='#ffeef8'; roundRect(ox-12*DPR, oy-12*DPR, gw+24*DPR, gh+24*DPR, 24*DPR, true, false); for(let y=0;y<g.rows;y++){ for(let x=0;x<g.cols;x++){ ctx.fillStyle=((x+y)%2==0?'#ffe1f0':'#ffd6eb'); ctx.fillRect(ox+x*g.size, oy+y*g.size, g.size, g.size); } } const cx=ox+snake.cheese.x*g.size+g.size/2, cy=oy+snake.cheese.y*g.size+g.size/2; drawCheese(cx,cy,g.size*0.8); for(let i=0;i<snake.body.length;i++){ const b=snake.body[i]; const x=ox+b.x*g.size+g.size/2, y=oy+b.y*g.size+g.size/2; drawMouseSegment(x,y,g.size*0.9, i===0? snake.dir : null); } ctx.fillStyle='#5a4b57'; ctx.font=`${Math.floor(22*DPR)}px system-ui`; ctx.textAlign='center'; ctx.fillText('Mit Pfeiltasten steuern. Iss Käse = neues Kantonesisch‑Wort!', W/2, oy+gh+50*DPR); const bw=220*DPR,bh=90*DPR; const bx=W/2-bw/2, by=oy+gh+80*DPR; button({x:bx,y:by,w:bw,h:bh,label: snake.playing?'Neustart':'Start',bg:'#e9deff'}); addHit('startsnake', bx,by,bw,bh, ()=>resetSnake()); stepSnake(ox,oy); }
  window.addEventListener('keydown', e=>{ if(ui.mode!=='snake') return; const k=e.key; if((k==='ArrowUp'||k==='w') && snake.dir.y!==1) snake.dir={x:0,y:-1}; else if((k==='ArrowDown'||k==='s') && snake.dir.y!==-1) snake.dir={x:0,y:1}; else if((k==='ArrowLeft'||k==='a') && snake.dir.x!==1) snake.dir={x:-1,y:0}; else if((k==='ArrowRight'||k==='d') && snake.dir.x!==-1) snake.dir={x:1,y:0}; });

  // ====== Frame & input loops ======
  function frame(){ drawBackground(); drawSparkles(); if(ui.mode==='home') drawHome(); else if(ui.mode==='flash') drawFlashcards(); else if(ui.mode==='quiz') drawQuiz(); else if(ui.mode==='snake') drawSnake(); requestAnimationFrame(frame); }
  requestAnimationFrame(frame);
  function processInput(){ if(input.tap){ const mx=input.x, my=input.y; for(let i=hits.length-1;i>=0;i--){ const r=hits[i]; if(inRect(mx,my,r)){ r.onClick(); break; } } addSparkles(mx,my, 10); input.tap=false; } hits.length=0; requestAnimationFrame(processInput); }
  requestAnimationFrame(processInput);
  </script>
</body>
</html>
